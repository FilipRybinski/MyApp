name: Publish Services

on:
  workflow_dispatch:
  push:
    branches:
      - microservices-microfrontends

env:
  REGISTRY: ghcr.io

jobs:
  initialize-environment:
    name: Initialize Environment
    runs-on: ubuntu-latest

    outputs:
      repo_name: ${{ steps.extract-name.outputs.REPO_NAME }} 

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Extract Repository Name
        id: extract-name
        uses: ./.github/actions/extract-repo-name

  publish-services:
    name: Publish Services
    needs: initialize-environment
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - name: "identity"
            dockerPath: "./microservices/Identity/Identity.Api/Dockerfile"
            settingsPath: "./microservices/Identity/Identity.Api/appsettings.json"
            settings_secret: "IDENTITY_SETTINGS"

          - name: "featureflags"
            dockerPath: "./microservices/FeatureFlags/FeatureFlags.Api/Dockerfile"
            settingsPath: "./microservices/FeatureFlags/FeatureFlags.Api/appsettings.json"
            settings_secret: "FEATUREFLAGS_SETTINGS"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Login to Docker
        uses: ./.github/actions/login-to-docker
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.REGISTRY_TOKEN }}

      - name: Update Shared Settings
        uses: restackio/update-json-values-action@v1.0.0
        with:
          file: "./microservices/Shared/Shared/sharedSettings.json"
          values: ${{ secrets.SHARED_SETTINGS }}

      - name: Update ${{ matrix.name }} Settings
        uses: restackio/update-json-values-action@v1.0.0
        with:
          file: ${{ matrix.settingsPath }}
          values: ${{ secrets[matrix.settings_secret] }}

      - name: Build and Publish ${{ matrix.name }} Service
        uses: ./.github/actions/build-and-publish-docker
        with:
          dockerfile: ${{ matrix.dockerPath }}
          image_name: ${{ matrix.name }}
          registry: ${{ env.REGISTRY }}
          namespace: ${{ needs.initialize-environment.outputs.repo_name }}
